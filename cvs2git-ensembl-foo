#! /bin/sh

# Written using Git 1.7.2.3, may work with older
#
# Recommend running like
#    TMPDIR=/dev/shm ./git-importing/cvs2git-ensembl-foo otter


# We assume this for error catching
set -e

# Verbosity is optional
#set -x

GIDIR=$(
    cd $( dirname $0 )
    echo $PWD
)
export PATH=$GIDIR:$PATH

# Import functions
source $GIDIR/cvs2git-funcs

diffok=0
diffbad=0

PROJ=ensembl-${1:-foo}
echo Running for PROJ=$PROJ

C2G_TMP=`mktemp -d -t cvs2git-$PROJ.XXXXXX`
trap 'echo -e "\nLeaving you to clean up: C2G_TMP=$C2G_TMP\n  rm -rf $C2G_TMP"' EXIT

REPOCVS=$C2G_TMP/repo

REPOGIT=$C2G_TMP/git

unpack_hwime ~/tmp/$PROJ.repo.tgz || fetchrepo
canon_repocvs ENSCOPY

apply_hackery

unpack_hwime ~/tmp/$PROJ.git.tgz  || do_import
### squirrel away some shortcut tarballs?  nb. keep or make the original CVSROOT/config LockDir
# (cd $C2G_TMP && tar cfz ~/tmp/$PROJ.repo.tgz repo locks)
# (cd $C2G_TMP && tar cfz ~/tmp/$PROJ.git.tgz git)

echo -e "\nTo view\n  (cd $REPOGIT && gitk --all &)\n\n"

cd $REPOGIT
refs_tag=$( git tag -l | perl -pe 's/^/    /')
refs_branch=$( git branch --no-color | perl -ne 's/^[ *]+//; next if m{^master$}; s{^}{    }; print' )

cat > $C2G_TMP/checkrevs.txt <<LST
Will compare CVS vs. Git contents for

  HEAD vs. master

  tags:
$refs_tag

  branches:
$refs_branch


LST
cat $C2G_TMP/checkrevs.txt

cd $C2G_TMP
checktag HEAD master
for tag in $refs_tag $refs_branch; do
    checktag $tag
done

# Rename all CVS branches & tags down a level
for ref in $refs_branch; do
    git branch -m $ref cvs/$ref
done
for ref in $refs_tag; do
    echo -ne "Create tag cvs/$ref; \t"
    git tag cvs/$ref $ref
    git tag -d $ref
done
# Retain master from CVS MAIN
git branch cvs/main master


# Reset the repo to a plain master
cd $REPOGIT
git gc
git checkout -q master
git reset --hard HEAD
git clean -fdqx
git branch -D _diff_to_cvs


# Show diffing summary
echo -e "\n\nDiffed some tags and/or branches.\n  Found $diffok with no diff.\n  Found $diffbad with differences between CVS and Git,\n    see $C2G_TMP/checkrevs/\n\n"
find $C2G_TMP/checkrevs/ -type f -size +0 -ls
